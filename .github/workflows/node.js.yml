name: CI/CD BACKEND

on:
  push:
    branches:
      - '**'        # roda em qualquer branch
  pull_request:
    branches:
      - '**'        # roda em qualquer PR
  workflow_dispatch:

jobs:
  deploy-env:
    runs-on: self-hosted
    timeout-minutes: 5
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar Node.js instalado
        run: |
          node --version || echo "‚ö†Ô∏è Node.js n√£o encontrado, mas continuando..."
          npm --version || echo "‚ö†Ô∏è npm n√£o encontrado, mas continuando..."

      - name: Verificar secret PROD_ENV_FILE
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          if [ -z "$PROD_ENV_FILE" ]; then
            echo "‚ùå ERRO: Secret PROD_ENV_FILE est√° vazio ou n√£o configurado!"
            echo "‚ö†Ô∏è Configure o secret no GitHub: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          else
            SECRET_SIZE=${#PROD_ENV_FILE}
            echo "‚úÖ Secret PROD_ENV_FILE configurado (${SECRET_SIZE} caracteres)"
            if [ $SECRET_SIZE -eq 0 ]; then
              echo "‚ùå ERRO: Secret est√° vazio!"
              exit 1
            fi
          fi

      - name: Criar .env no diret√≥rio do PM2
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          # Verificar onde o PM2 BackendAPI est√° rodando
          echo "üîç Procurando processo PM2: BackendAPI"
          PM2_INFO=$(pm2 describe BackendAPI 2>/dev/null || echo "")
          
          if [ -n "$PM2_INFO" ]; then
            # Extrair o diret√≥rio de trabalho do PM2
            PM2_CWD=$(pm2 describe BackendAPI 2>/dev/null | grep "exec cwd" | awk '{print $NF}' || echo "")
            
            if [ -n "$PM2_CWD" ]; then
              TARGET_DIR="$PM2_CWD"
              echo "‚úÖ PM2 BackendAPI encontrado!"
              echo "üìç PM2 rodando de: $TARGET_DIR"
            else
              # Tentar extrair do pm2 show
              PM2_CWD=$(pm2 show BackendAPI 2>/dev/null | grep "exec cwd" | awk '{print $NF}' || echo "")
              if [ -n "$PM2_CWD" ]; then
                TARGET_DIR="$PM2_CWD"
                echo "‚úÖ PM2 BackendAPI encontrado via pm2 show!"
                echo "üìç PM2 rodando de: $TARGET_DIR"
              else
                # Fallback: procurar em locais comuns
                PM2_DIR1="$HOME/SGOT/apps/backend"
                PM2_DIR2="/var/www/api-backend/current/apps/backend"
                
                if [ -d "$PM2_DIR1" ]; then
                  TARGET_DIR="$PM2_DIR1"
                  echo "üìç Usando diret√≥rio padr√£o: $TARGET_DIR"
                elif [ -d "$PM2_DIR2" ]; then
                  TARGET_DIR="$PM2_DIR2"
                  echo "üìç Usando diret√≥rio de deploy: $TARGET_DIR"
                else
                  echo "‚ö†Ô∏è Diret√≥rio n√£o encontrado, criando em $PM2_DIR1"
                  mkdir -p "$PM2_DIR1"
                  TARGET_DIR="$PM2_DIR1"
                fi
              fi
            fi
          else
            echo "‚ö†Ô∏è Processo BackendAPI n√£o encontrado no PM2, usando diret√≥rios padr√£o"
            PM2_DIR1="$HOME/SGOT/apps/backend"
            PM2_DIR2="/var/www/api-backend/current/apps/backend"
            
            if [ -d "$PM2_DIR1" ]; then
              TARGET_DIR="$PM2_DIR1"
              echo "üìç Usando diret√≥rio: $TARGET_DIR"
            elif [ -d "$PM2_DIR2" ]; then
              TARGET_DIR="$PM2_DIR2"
              echo "üìç Usando diret√≥rio: $TARGET_DIR"
            else
              echo "‚ö†Ô∏è Criando diret√≥rio em $PM2_DIR1"
              mkdir -p "$PM2_DIR1"
              TARGET_DIR="$PM2_DIR1"
            fi
          fi
          
          # Criar diret√≥rio se n√£o existir
          mkdir -p "$TARGET_DIR"
          echo "üìÇ Criando .env em: $TARGET_DIR"
          
          # Criar o arquivo .env
          printf '%s\n' "$PROD_ENV_FILE" > "$TARGET_DIR/.env"
          
          # Verificar se foi criado
          if [ ! -f "$TARGET_DIR/.env" ]; then
            echo "‚ùå ERRO: Arquivo .env N√ÉO foi criado em $TARGET_DIR!"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < "$TARGET_DIR/.env")
          if [ $FILE_SIZE -eq 0 ]; then
            echo "‚ùå ERRO: Arquivo .env est√° VAZIO!"
            exit 1
          fi
          
          # Ajustar permiss√µes
          chmod 600 "$TARGET_DIR/.env"
          
          echo "‚úÖ Arquivo .env criado com sucesso!"
          echo "üìè Tamanho: $FILE_SIZE bytes"
          echo "üìç Localiza√ß√£o: $TARGET_DIR/.env"
          echo "üîí Permiss√µes: 600"

      - name: Restart PM2 BackendAPI
        run: |
          # Verificar se o processo BackendAPI existe
          if pm2 describe BackendAPI > /dev/null 2>&1; then
            echo "üîÑ Reiniciando PM2 processo: BackendAPI"
            pm2 restart BackendAPI
            pm2 save
            echo "‚úÖ PM2 BackendAPI reiniciado com sucesso!"
          else
            echo "‚ùå ERRO: Processo 'BackendAPI' n√£o encontrado no PM2"
            echo "üìã Processos PM2 ativos:"
            pm2 list
            echo ""
            echo "üí° Dica: Crie o processo PM2 com: pm2 start apps/backend/src/server.js --name BackendAPI"
            exit 1
            
          fi