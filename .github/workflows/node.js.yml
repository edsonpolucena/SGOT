# name: CI/CD BACKEND

# on:

#   push:
#     branches:
#       - '**'        # roda em qualquer branch
#   pull_request:
#     branches:
#       - '**'        # roda em qualquer PR
#   workflow_dispatch:

# jobs:
#   build:
#     runs-on: self-hosted
#     strategy:
#       matrix:
#         node-version: [20.x]

#     steps:
#       - name: Checkout código
#         uses: actions/checkout@v4

#       - name: Usar Node.js ${{ matrix.node-version }}
#         uses: actions/setup-node@v4
#         with:
#           node-version: ${{ matrix.node-version }}
#           cache: npm
#           cache-dependency-path: ./apps/backend/package-lock.json

#       - name: Instalar dependências
#         working-directory: ./apps/backend
#         run: npm install

#       - name: Criar .env no backend
#         working-directory: ./apps/backend
#         run: |
#           touch .env
#           echo "${{ secrets.PROD_ENV_FILE }}" > .env

#       # Opcional: build
#       # - name: Build
#       #   working-directory: ./backend
#       #   run: npm run build

#       #- name: Rodar testes
#       #  working-directory: ./backend
#       #  run: npm test   # ou npm run test, se for o caso

#       - name: Restart PM2 
#         working-directory: ./apps/backend
#         run: pm2 restart BackendAPI

name: Deploy Backend SGOT

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:

      # 1) Clonar código no runner (temporário)
      - name: Checkout código
        uses: actions/checkout@v4

      # 2) Copiar arquivos para a pasta de produção (sem node_modules)
      - name: Deploy para pasta de produção
        run: |
          rsync -az --delete --exclude=node_modules --exclude=.env ./ /home/ubuntu/SGOT/

      # 3) Atualizar .env da produção
      - name: Criar .env de produção
        run: |
          echo "${{ secrets.PROD_ENV_FILE }}" > /home/ubuntu/SGOT/apps/backend/.env
          chmod 600 /home/ubuntu/SGOT/apps/backend/.env

      # 4) Reiniciar backend SEM reinstalar dependências
      - name: Reiniciar PM2
        run: |
          cd /home/ubuntu/SGOT/apps/backend
          pm2 restart BackendAPI || pm2 start src/server.js --name BackendAPI
