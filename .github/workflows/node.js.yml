name: Node.js CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      -  run: npm ci

      - name: Debug - Verificar diret√≥rio atual
        run: |
          echo "üìÇ Diret√≥rio atual:"
          pwd
          echo ""
          echo "üìÅ Estrutura de diret√≥rios:"
          ls -la
          echo ""
          echo "üìÅ Verificando apps/backend:"
          ls -la apps/backend/ 2>&1 || echo "‚ùå Diret√≥rio apps/backend n√£o existe"

      - name: Debug - Verificar secret PROD_ENV_FILE
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          if [ -z "$PROD_ENV_FILE" ]; then
            echo "‚ùå ERRO: Secret PROD_ENV_FILE est√° vazio ou n√£o configurado!"
            echo "‚ö†Ô∏è Verifique se o secret 'PROD_ENV_FILE' est√° configurado no GitHub:"
            echo "   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Secrets"
            exit 1
          else
            echo "‚úÖ Secret PROD_ENV_FILE est√° configurado"
            SECRET_SIZE=${#PROD_ENV_FILE}
            echo "üìè Tamanho do secret: $SECRET_SIZE caracteres"
            if [ $SECRET_SIZE -eq 0 ]; then
              echo "‚ùå ERRO: Secret est√° vazio (0 caracteres)!"
              exit 1
            fi
            echo "üìÑ Primeiras 3 linhas do secret (sem expor dados sens√≠veis):"
            echo "$PROD_ENV_FILE" | head -3
          fi

      - name: Criar .env no backend
        env:
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          # Garantir que o diret√≥rio existe
          mkdir -p apps/backend
          
          # Verificar se o secret est√° dispon√≠vel
          if [ -z "$PROD_ENV_FILE" ]; then
            echo "‚ùå ERRO: PROD_ENV_FILE n√£o est√° dispon√≠vel neste step!"
            exit 1
          fi
          
          # Criar o arquivo .env usando printf para evitar problemas com caracteres especiais
          printf '%s\n' "$PROD_ENV_FILE" > apps/backend/.env
          
          # Verificar se foi criado
          if [ ! -f apps/backend/.env ]; then
            echo "‚ùå ERRO: Arquivo .env N√ÉO foi criado!"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < apps/backend/.env)
          if [ $FILE_SIZE -eq 0 ]; then
            echo "‚ùå ERRO: Arquivo .env foi criado mas est√° VAZIO!"
            exit 1
          fi
          
          echo "‚úÖ Arquivo .env criado com sucesso!"
          echo "üìè Tamanho do arquivo: $FILE_SIZE bytes"
          echo "üìç Localiza√ß√£o: $(pwd)/apps/backend/.env"
          echo "üìÑ Primeiras 3 linhas do arquivo (sem expor dados sens√≠veis):"
          head -3 apps/backend/.env
          
          # Verificar permiss√µes
          chmod 600 apps/backend/.env
          echo "üîí Permiss√µes ajustadas para 600 (leitura/escrita apenas para o dono)"

      - name: Verificar permiss√µes do .env
        run: |
          ls -la apps/backend/.env
          echo ""
          echo "üìã Conte√∫do do arquivo .env (primeiras 5 linhas):"
          head -5 apps/backend/.env || echo "Erro ao ler arquivo"
