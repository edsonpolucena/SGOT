name: CI/CD SGOT (EC2)

on:
  push:
    branches: [ main ]

jobs:
  ci-cd:
    runs-on: self-hosted   # Usa o runner da sua EC2
    timeout-minutes: 30    # Timeout de 30 minutos para evitar travamentos

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =======================================================
      # COPIAR CÓDIGO PARA O DIRETÓRIO DE PRODUÇÃO
      # =======================================================
      - name: Sincronizar código para /home/ubuntu/SGOT
        timeout-minutes: 5
        run: |
          sudo rsync -av \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='**/.env' \
            --exclude='.package-lock.deployed' \
            ${{ github.workspace }}/ /home/ubuntu/SGOT/
          sudo chown -R ubuntu:ubuntu /home/ubuntu/SGOT

      # =======================================================
      # DOCKER (PostgreSQL)
      # =======================================================
      - name: Verificar/Iniciar PostgreSQL
        timeout-minutes: 2
        run: |
          cd /var/www/sgot || cd /home/ubuntu/SGOT
          docker compose -f docker-compose.prod.yml ps 2>/dev/null || echo "Verificando Docker..."
          docker compose -f docker-compose.prod.yml up -d 2>/dev/null || echo "Docker já está rodando ou erro ao iniciar"
          sleep 3
          docker ps | grep postgres || echo "PostgreSQL pode não estar rodando"

      # =======================================================
      # BACKEND
      # =======================================================
      - name: Instalar dependências do backend (só se necessário)
        timeout-minutes: 10
        working-directory: /home/ubuntu/SGOT/apps/backend
        run: |
          # Verifica se node_modules existe e se package-lock.json mudou
          if [ ! -d "node_modules" ]; then
            echo "❌ node_modules não existe -> instalando dependências"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error
            cp package-lock.json .package-lock.deployed 2>/dev/null || true
          elif [ ! -f ".package-lock.deployed" ] || ! cmp -s package-lock.json .package-lock.deployed 2>/dev/null; then
            echo "⚠️ package-lock.json mudou -> atualizando dependências"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error
            cp package-lock.json .package-lock.deployed
          else
            echo "✅ Dependências do backend já instaladas e sem mudanças -> pulando npm install"
          fi

      - name: Gerar Prisma Client (só se necessário)
        timeout-minutes: 2
        working-directory: /home/ubuntu/SGOT/apps/backend
        run: |
          # Só gera se o Prisma Client não existir ou se o schema mudou
          if [ ! -d "node_modules/.prisma/client" ] || [ "prisma/schema.prisma" -nt "node_modules/.prisma/client" ]; then
            echo "Gerando Prisma Client..."
            npx prisma generate
          else
            echo "✅ Prisma Client já está atualizado -> pulando geração"
          fi

      - name: Aplicar migrations
        timeout-minutes: 2
        working-directory: /home/ubuntu/SGOT/apps/backend
        run: |
          npx prisma migrate deploy || echo "Sem migrations para aplicar"

      - name: Restart backend com PM2
        timeout-minutes: 1
        run: |
          cd /home/ubuntu/SGOT
          pm2 restart backend-api 2>/dev/null || pm2 start apps/backend/src/server.js --name backend-api --env production
          pm2 save 2>/dev/null || true

      # =======================================================
      # FRONTEND
      # =======================================================
      - name: Instalar dependências do frontend (só se necessário)
        timeout-minutes: 10
        working-directory: /home/ubuntu/SGOT/apps/frontend
        env:
          npm_config_cache: /home/ubuntu/.npm-cache
        run: |
          # Verifica se node_modules existe e se package-lock.json mudou
          if [ ! -d "node_modules" ]; then
            echo "❌ node_modules não existe -> instalando dependências"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error --cache=/home/ubuntu/.npm-cache
            cp package-lock.json .package-lock.deployed 2>/dev/null || true
          elif [ ! -f ".package-lock.deployed" ] || ! cmp -s package-lock.json .package-lock.deployed 2>/dev/null; then
            echo "⚠️ package-lock.json mudou -> atualizando dependências"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error --cache=/home/ubuntu/.npm-cache
            cp package-lock.json .package-lock.deployed
          else
            echo "✅ Dependências do frontend já instaladas e sem mudanças -> pulando npm install"
          fi

      - name: Verificar se precisa buildar frontend
        id: check_frontend_build
        timeout-minutes: 2
        working-directory: /home/ubuntu/SGOT/apps/frontend
        run: |
          # Se não existe dist ou timestamp, precisa buildar
          if [ ! -d "dist" ] || [ ! -f "dist/.build.timestamp" ]; then
            echo "Nenhum build anterior encontrado -> irá buildar"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Verifica se arquivos fonte mudaram desde o último build
          # Verifica src/, public/, package.json, vite.config.*, e .env (se existir)
          CHANGED_FILES=$(find src public package.json vite.config.* .env 2>/dev/null -newer dist/.build.timestamp -print -quit)
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "Arquivos alterados desde o último build -> irá buildar"
            echo "Arquivos alterados: $CHANGED_FILES"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "✅ Nenhuma alteração relevante desde o último build -> NÃO irá buildar"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Build frontend (otimizado)
        if: steps.check_frontend_build.outputs.should_build == 'true'
        timeout-minutes: 10
        working-directory: /home/ubuntu/SGOT/apps/frontend
        env:
          VITE_API_URL: https://www.sgot.com.br
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=2048 --no-warnings
          # Variáveis para acelerar o build
          CI: false
          # Preserva cache do Vite entre builds
          VITE_CACHE_DIR: /home/ubuntu/.vite-cache
        run: |
          # Criar diretório de cache se não existir
          mkdir -p /home/ubuntu/.vite-cache
          
          # Build com flags otimizadas para ser mais rápido
          # --mode production: modo de produção
          # --minify esbuild: minificação rápida com esbuild (mais rápido que terser)
          # --emptyOutDir: limpa diretório de saída antes
          npm run build -- --mode production --minify esbuild --emptyOutDir
          
          # Criar timestamp do build para verificação futura
          mkdir -p dist
          touch dist/.build.timestamp

      - name: Publicar frontend no Nginx
        if: steps.check_frontend_build.outputs.should_build == 'true'
        timeout-minutes: 1
        run: |
          sudo chown -R www-data:www-data /home/ubuntu/SGOT/apps/frontend/dist
          sudo chmod -R 755 /home/ubuntu/SGOT/apps/frontend/dist
          sudo systemctl reload nginx

