name: CI/CD SGOT (EC2)

on:
  push:
    branches: [ main ]

jobs:
  ci-cd:
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =======================================================
      # COPIAR CÃ“DIGO PARA O DIRETÃ“RIO DE PRODUÃ‡ÃƒO
      # =======================================================
      - name: Sincronizar cÃ³digo para /home/ubuntu/SGOT
        timeout-minutes: 5
        run: |
          sudo rsync -av \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='**/.env' \
            --exclude='.package-lock.deployed' \
            ${{ github.workspace }}/ /home/ubuntu/SGOT/
          sudo chown -R ubuntu:ubuntu /home/ubuntu/SGOT

      # =======================================================
      # DOCKER (PostgreSQL)
      # =======================================================
      - name: Verificar/Iniciar PostgreSQL
        timeout-minutes: 2
        run: |
          cd /var/www/sgot || cd /home/ubuntu/SGOT
          docker compose -f docker-compose.prod.yml ps 2>/dev/null || echo "Verificando Docker..."
          docker compose -f docker-compose.prod.yml up -d 2>/dev/null || echo "Docker jÃ¡ estÃ¡ rodando ou erro ao iniciar"
          sleep 3
          docker ps | grep postgres || echo "PostgreSQL pode nÃ£o estar rodando"

      # =======================================================
      # BACKEND
      # =======================================================
      - name: Instalar dependÃªncias do backend (sÃ³ se necessÃ¡rio)
        timeout-minutes: 10
        working-directory: /home/ubuntu/SGOT/apps/backend
        run: |
          if [ ! -d "node_modules" ]; then
            echo "âŒ node_modules nÃ£o existe -> instalando dependÃªncias"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error
            cp package-lock.json .package-lock.deployed 2>/dev/null || true
          elif [ ! -f ".package-lock.deployed" ] || ! cmp -s package-lock.json .package-lock.deployed 2>/dev/null; then
            echo "âš ï¸ package-lock.json mudou -> atualizando dependÃªncias"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error
            cp package-lock.json .package-lock.deployed
          else
            echo "âœ… DependÃªncias do backend jÃ¡ instaladas e sem mudanÃ§as -> pulando npm install"
          fi

      - name: Gerar Prisma Client
        timeout-minutes: 2
        working-directory: /home/ubuntu/SGOT/apps/backend
        run: |
          if [ ! -d "node_modules/.prisma/client" ] || [ "prisma/schema.prisma" -nt "node_modules/.prisma/client" ]; then
            echo "Gerando Prisma Client..."
            npx prisma generate
          else
            echo "âœ… Prisma Client jÃ¡ estÃ¡ atualizado"
          fi

      - name: Aplicar migrations
        timeout-minutes: 2
        working-directory: /home/ubuntu/SGOT/apps/backend
        run: |
          npx prisma migrate deploy || echo "Sem migrations"

      - name: Restart backend com PM2
        timeout-minutes: 1
        run: |
          cd /home/ubuntu/SGOT
          pm2 restart backend-api 2>/dev/null || pm2 start apps/backend/src/server.js --name backend-api --env production
          pm2 save 2>/dev/null || true

            # =======================================================
      # FRONTEND (com hash e sem rebuild desnecessÃ¡rio)
      # =======================================================
      - name: Instalar dependÃªncias do frontend (sÃ³ se necessÃ¡rio)
        timeout-minutes: 10
        working-directory: /home/ubuntu/SGOT/apps/frontend
        env:
          npm_config_cache: /home/ubuntu/.npm-cache
        run: |
          if [ ! -d "node_modules" ]; then
            echo "âŒ node_modules do frontend nÃ£o existe -> instalando"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error --cache=/home/ubuntu/.npm-cache
            cp package-lock.json .package-lock.deployed 2>/dev/null || true
          elif [ ! -f ".package-lock.deployed" ] || ! cmp -s package-lock.json .package-lock.deployed 2>/dev/null; then
            echo "âš ï¸ package-lock.json mudou -> instalando dependÃªncias do frontend"
            npm install --prefer-offline --no-audit --progress=false --loglevel=error --cache=/home/ubuntu/.npm-cache
            cp package-lock.json .package-lock.deployed
          else
            echo "âœ… DependÃªncias do frontend jÃ¡ instaladas e sem mudanÃ§as"
          fi

      - name: Verificar se precisa buildar frontend
        id: check_frontend_build
        timeout-minutes: 2
        working-directory: /home/ubuntu/SGOT/apps/frontend
        run: |
          # Gera hash do conteÃºdo dos arquivos fonte relevantes
          CURRENT_HASH=$(find src public package.json vite.config.* .env 2>/dev/null -type f -exec md5sum {} \; 2>/dev/null | sort | md5sum | cut -d' ' -f1)

          # Se a pasta dist NÃƒO existe, build Ã© obrigatÃ³rio
          if [ ! -d "dist" ]; then
            echo "ðŸš§ dist nÃ£o existe -> build necessÃ¡rio"
            echo "Hash atual: $CURRENT_HASH"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Se dist existe mas NÃƒO tem hash salvo, assume que o build atual Ã© vÃ¡lido
          if [ ! -f ".last-build.hash" ]; then
            echo "ðŸ“ dist existe mas nÃ£o hÃ¡ hash -> considerando build atual como vÃ¡lido e salvando hash"
            echo "$CURRENT_HASH" > .last-build.hash
            echo "Hash salvo: $CURRENT_HASH"
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # LÃª hash do build anterior
          LAST_HASH=$(cat .last-build.hash)

          # Compara hashes
          if [ "$CURRENT_HASH" = "$LAST_HASH" ]; then
            echo "âœ… ConteÃºdo do frontend NÃƒO mudou -> NÃƒO precisa buildar"
            echo "Hash atual: $CURRENT_HASH"
            echo "Hash anterior: $LAST_HASH"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ ConteÃºdo do frontend mudou -> precisa buildar"
            echo "Hash atual: $CURRENT_HASH"
            echo "Hash anterior: $LAST_HASH"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Build frontend (otimizado)
        if: steps.check_frontend_build.outputs.should_build == 'true'
        timeout-minutes: 20
        working-directory: /home/ubuntu/SGOT/apps/frontend
        env:
          VITE_API_URL: https://www.sgot.com.br
          NODE_ENV: production
          NODE_OPTIONS: --max-old-space-size=2048 --no-warnings
          CI: false
          VITE_CACHE_DIR: /home/ubuntu/.vite-cache
        run: |
          mkdir -p /home/ubuntu/.vite-cache
          nice -n 10 npm run build -- --mode production --minify esbuild --emptyOutDir
          
          # Depois do build bem-sucedido, salva o hash atual
          CURRENT_HASH=$(find src public package.json vite.config.* .env 2>/dev/null -type f -exec md5sum {} \; 2>/dev/null | sort | md5sum | cut -d' ' -f1)
          echo "$CURRENT_HASH" > .last-build.hash
          echo "Hash do build salvo: $CURRENT_HASH"

      - name: Publicar frontend no Nginx
        if: steps.check_frontend_build.outputs.should_build == 'true'
        timeout-minutes: 1
        run: |
          sudo chown -R www-data:www-data /home/ubuntu/SGOT/apps/frontend/dist
          sudo chmod -R 755 /home/ubuntu/SGOT/apps/frontend/dist
          sudo systemctl reload nginx
