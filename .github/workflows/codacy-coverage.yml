name: Codacy Coverage

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        ports:
          - 5434:5432
        env:
          POSTGRES_USER: sgot_test
          POSTGRES_PASSWORD: sgot_test_password
          POSTGRES_DB: sgot_test
        options: >-
          --health-cmd "pg_isready -U sgot_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      NODE_ENV: test
      DATABASE_URL: postgresql://sgot_test:sgot_test_password@localhost:5434/sgot_test
      CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =======================
      # BACKEND
      # =======================
      - name: Install backend deps
        working-directory: apps/backend
        run: npm ci

      - name: Run backend tests with coverage
        working-directory: apps/backend
        run: npm run test:ci
        # se algum teste falhar, ainda queremos enviar coverage
        continue-on-error: true

      # =======================
      # FRONTEND (opcional)
      # =======================
      - name: Install frontend deps
        working-directory: apps/frontend
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: apps/frontend
        run: |
          npm run test:ci || true
        continue-on-error: true

      # =======================
      # ENVIAR COVERAGE PARA O CODACY
      # =======================
      - name: Download Codacy Coverage Reporter
        run: |
          curl -Ls https://coverage.codacy.com/get.sh -o codacy-coverage-reporter.sh
          chmod +x codacy-coverage-reporter.sh

      - name: Upload backend coverage to Codacy
        run: |
          ./codacy-coverage-reporter.sh report \
            -l JavaScript \
            -r apps/backend/coverage/lcov.info \
            --partial

      - name: Upload frontend coverage to Codacy
        run: |
          ./codacy-coverage-reporter.sh report \
            -l JavaScript \
            -r apps/frontend/coverage/lcov.info \
            --partial || echo "⚠️ Sem coverage do frontend"

      - name: Finalize Codacy Coverage
        run: ./codacy-coverage-reporter.sh final
